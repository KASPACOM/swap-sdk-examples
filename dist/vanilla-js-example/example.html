<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swap Sdk Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 24px;
            background: #0f172a;
            color: #e2e8f0;
        }

        .container {
            max-width: 920px;
            margin: 0 auto;
        }

        .card {
            background: #0b1022;
            border: 1px solid #1e293b;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .col {
            flex: 1;
            min-width: 220px;
        }

        label {
            display: block;
            font-size: 12px;
            color: #93c5fd;
            margin-bottom: 6px;
        }

        select,
        input[type="text"],
        input[type="number"],
        button {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #334155;
            background: #0f172a;
            color: #e2e8f0;
            font-size: 14px;
        }

        button.primary {
            background: #3b82f6;
            border-color: #3b82f6;
            cursor: pointer;
        }

        button.secondary {
            background: #1e293b;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 10px;
            background: #0b1022;
            border: 1px solid #1e293b;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            background: #1e293b;
            color: #93c5fd;
            font-size: 12px;
        }

        .muted {
            color: #94a3b8;
            font-size: 13px;
        }

        .error {
            color: #fecaca;
        }

        .success {
            color: #bbf7d0;
        }

        h1 {
            margin: 0 0 16px;
            font-size: 22px;
        }

        h2 {
            margin: 24px 0 10px;
            font-size: 16px;
            color: #93c5fd;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <h1>Headless Swap (Custom UI)</h1>

            <div class="row">
                <div class="col">
                    <label>Wallet</label>
                    <div class="actions">
                        <button id="connectBtn" class="primary">Connect</button>
                        <button id="disconnectBtn" class="secondary">Disconnect</button>
                    </div>
                    <div class="muted" id="walletInfo">Not connected</div>
                </div>
                <div class="col">
                    <label>Settings</label>
                    <div class="row">
                        <div class="col">
                            <input type="text" id="slippageInput" placeholder="Max slippage %" value="0.5" />
                        </div>
                        <div class="col">
                            <input type="text" id="deadlineInput" placeholder="Deadline (min)" value="20" />
                        </div>
                    </div>
                </div>
            </div>

            <h2>Trade</h2>
            <div class="row">
                <div class="col">
                    <label>Mode</label>
                    <select id="modeSelect">
                        <option value="sell">Sell (enter input)</option>
                        <option value="buy">Buy (enter target output)</option>
                    </select>
                </div>
                <div class="col">
                    <label>From token</label>
                    <select id="sellTokenSelect"></select>
                </div>
                <div class="col">
                    <label>To token</label>
                    <select id="buyTokenSelect"></select>
                </div>
                <div class="col">
                    <label id="amountLabel">Amount (sell)</label>
                    <input type="number" id="amountInput" placeholder="0.0" />
                </div>
            </div>

            <div class="actions">
                <div id="loadingMessage" style="display: none; text-align: center; color: #93c5fd; font-size: 14px;">
                    Processing... Please wait
                </div>
                <button id="swapBtn" class="primary" disabled>Swap</button>
            </div>

            <div class="status" id="statusBox">
                <div>
                    <span class="pill" id="statusPill">idle</span>
                </div>
                <div class="grid" style="margin-top:10px">
                    <div>
                        <div class="muted">Required amount</div>
                        <div id="requiredAmount">-</div>
                    </div>
                    <div>
                        <div class="muted">Expected amount out</div>
                        <div id="expectedOut">-</div>
                    </div>
                    <div>
                        <div class="muted">Min amount out (after slippage)</div>
                        <div id="minOut">-</div>
                    </div>
                    <div>
                        <div class="muted">Path</div>
                        <div id="tradePath" class="muted">-</div>
                    </div>
                </div>
                <div id="errorMsg" class="error" style="margin-top:8px"></div>
                <div id="txHash" class="success" style="margin-top:8px"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@kaspacom/swap-sdk@1.1.19/dist/index.global.js"></script>
    <script>
        const startingTokens = [
            { address: '0x0000000000000000000000000000000000000000', symbol: 'KAS', name: 'Kaspa', decimals: 18 },
            { address: '0xD33d07ccfEd8038cEd1aa393FbEf7D7dA72be20e', symbol: 'USDT', name: 'Tether', decimals: 6 },
            { address: '0x5266ae5ec8040d7f92c3ddd833e74d4cf3eaf1db', symbol: 'KSCM', name: 'KASPACOM TEST', decimals: 18 },
        ];

        let controller = null;
        let currentSellToken = startingTokens[0];
        let currentBuyToken = startingTokens[1];
        let currentMode = 'sell';


        function populateTokenSelect(select, tokens) {
            const prev = select.value;
            select.innerHTML = '';
            for (const t of tokens) {
                const opt = document.createElement('option');
                opt.value = t.address;
                opt.textContent = t.symbol + ' - ' + t.name + ' (' + t.address + ')';
                select.appendChild(opt);
            }
            if (tokens.find(t => t.address === prev)) select.value = prev;
        }

        function filterTokens(query) {
            const q = (query || '').trim().toLowerCase();
            if (!q) return startingTokens;
            return startingTokens.filter(t => t.symbol.toLowerCase().includes(q) || t.name.toLowerCase().includes(q));
        }

        function getTokenByAddress(addr) {
            return startingTokens.find(t => t.address.toLowerCase() === addr.toLowerCase());
        }

        function setStatusFromLoader(loader) {
            const map = { 1: 'calculating', 2: 'approving', 3: 'swapping' };
            document.getElementById('statusPill').textContent = loader ? (map[loader] || 'working') : 'idle';
        }

        function disconnectWallet(controller) {
            controller.disconnectWallet();
            document.getElementById('walletInfo').textContent = 'Not connected';
            scheduleSetData();
        }

        async function updateUIFromState(state, changes) {
            const requiredAmount = document.getElementById('requiredAmount');
            const expectedOut = document.getElementById('expectedOut');
            const minOut = document.getElementById('minOut');
            const tradePath = document.getElementById('tradePath');
            const errorMsg = document.getElementById('errorMsg');
            const txHash = document.getElementById('txHash');
            const swapBtn = document.getElementById('swapBtn');
            const loadingMessage = document.getElementById('loadingMessage');

            setStatusFromLoader(state.loader);

            // Show required amount (input amount)
            const amountInput = document.getElementById('amountInput');
            const currentAmount = amountInput.value || '0';

            // Handle computed amounts with proper fallbacks
            if (state.computed) {
                expectedOut.textContent = state.computed.amountOut ? state.computed.amountOut + ' ' + currentBuyToken.symbol : '-';
                minOut.textContent = currentMode === 'sell' ? (state.computed.minAmountOut + ' ' + currentBuyToken.symbol) : '-';
                requiredAmount.textContent = (currentMode === 'buy' ? state.computed.maxAmountIn : state.computed.amountIn) + ' ' + currentSellToken.symbol;
            } else {
                expectedOut.textContent = '-';
                minOut.textContent = '-';
                requiredAmount.textContent = '-';
            }

            // Try to get trade path from tradeInfo, otherwise show placeholder
            if (state.tradeInfo && state.tradeInfo.route && state.tradeInfo.route.path) {
                tradePath.textContent = state.tradeInfo.route.path.map(token => token.symbol).join(' â†’ ');
            } else {
                tradePath.textContent = '-';
            }

            errorMsg.textContent = state.error ? ('Error: ' + state.error) : '';

            if (state.txHash || state.approveTxHash) {
                if (!state.txHash) {
                    txHash.textContent = 'Approve Tx: ' + state.approveTxHash;
                } else {
                    txHash.textContent = 'Swap Tx: ' + state.txHash;
                }
            } else {
                txHash.textContent = '';
            }

            const isConnected = document.getElementById('walletInfo').textContent.startsWith('Connected:');
            const amount = document.getElementById('amountInput').value;
            const hasAmount = amount && Number(amount) > 0;
            const isBusy = !!state.loader;

            // Hide swap button when loading
            if (isBusy) {
                swapBtn.style.display = 'none';
                loadingMessage.style.display = 'block';

                // Show specific loading message based on loader status
                const loaderMessages = {
                    1: 'Calculating quote...',
                    2: 'Approving tokens...',
                    3: 'Processing swap...'
                };
                loadingMessage.textContent = loaderMessages[state.loader] || 'Processing... Please wait';

                // Need this to refresh the ui
                await new Promise(resolve => setTimeout(requestAnimationFrame(resolve), 0));
                await new Promise(resolve => setTimeout(requestAnimationFrame(resolve), 0));

            } else {
                swapBtn.style.display = 'block';
                loadingMessage.style.display = 'none';

                // Enable swap when connected, has amount, and not busy
                const readyToSwap = isConnected && hasAmount && !!(state.computed?.amountOut);
                swapBtn.disabled = !readyToSwap;
            }
        }

        let setDataTimer = null;
        function scheduleSetData() {
            if (!controller) return;
            if (setDataTimer) clearTimeout(setDataTimer);
            setDataTimer = setTimeout(async () => {
                const amount = document.getElementById('amountInput').value || '0';
                const slippage = document.getElementById('slippageInput').value || '0.5';
                const deadline = document.getElementById('deadlineInput').value || '20';
                await controller.setData({
                    fromToken: currentSellToken,
                    toToken: currentBuyToken,
                    amount: Number(amount || '0'),
                    isOutputAmount: currentMode === 'buy',
                    settings: { maxSlippage: slippage, swapDeadline: Number(deadline) }
                });
            }, 250);
        }

        async function init() {
            if (!window.KaspaComSwapSdk) {
                alert('Bundle not loaded');
                return;
            }

            if (typeof window !== 'undefined' && !window.ethereum) {
                alert('No wallet found')
                return;
            }


            controller = window.KaspaComSwapSdk.createKaspaComSwapController({
                networkConfig: 'kasplex-testnet',
                onChange: updateUIFromState,
                // partnerKey: '0x0000000000000000000000000000000000000000000000000000000000000000'

            });

            // Listen for account changes
            window.ethereum.on('accountsChanged', (accounts) => {
                console.log('accounts changed', accounts);
                disconnectWallet(controller);
            });

            // Listen for chain changes
            window.ethereum.on('chainChanged', (chainId) => {
                disconnectWallet(controller);
            });

            // Listen for disconnect
            window.ethereum.on('disconnect', () => {
                disconnectWallet(controller);
            });

            // Populate selects
            const sellSel = document.getElementById('sellTokenSelect');
            const buySel = document.getElementById('buyTokenSelect');
            const modeSel = document.getElementById('modeSelect');
            const amountInput = document.getElementById('amountInput');
            const amountLabel = document.getElementById('amountLabel');

            populateTokenSelect(sellSel, startingTokens);
            populateTokenSelect(buySel, startingTokens);
            sellSel.value = currentSellToken.address;
            buySel.value = currentBuyToken.address;

            modeSel.addEventListener('change', () => {
                currentMode = modeSel.value;
                amountLabel.textContent = currentMode === 'sell' ? 'Amount (sell)' : 'Amount (target buy)';
                scheduleSetData();
            });

            sellSel.addEventListener('change', () => {
                currentSellToken = getTokenByAddress(sellSel.value);
                if (currentSellToken.address === currentBuyToken.address) {
                    currentBuyToken = startingTokens.find(t => t.address !== currentSellToken.address) || currentBuyToken;
                    buySel.value = currentBuyToken.address;
                }
                scheduleSetData();
            });
            buySel.addEventListener('change', () => {
                currentBuyToken = getTokenByAddress(buySel.value);
                if (currentBuyToken.address === currentSellToken.address) {
                    currentSellToken = startingTokens.find(t => t.address !== currentBuyToken.address) || currentSellToken;
                    sellSel.value = currentSellToken.address;
                }
                scheduleSetData();
            });

            amountInput.addEventListener('input', scheduleSetData);
            document.getElementById('slippageInput').addEventListener('input', scheduleSetData);
            document.getElementById('deadlineInput').addEventListener('input', scheduleSetData);

            document.getElementById('connectBtn').addEventListener('click', async () => {
                try {
                    const addr = await controller.connectWallet(window.ethereum);
                    document.getElementById('walletInfo').textContent = 'Connected: ' + addr;
                    scheduleSetData();
                } catch (e) {
                    alert(e?.message || e);
                }
            });
            document.getElementById('disconnectBtn').addEventListener('click', () => {
                disconnectWallet(controller);
            });

            document.getElementById('swapBtn').addEventListener('click', async () => {
                try {
                    const tx = await controller.swap();
                    console.log('Swapped, tx:', tx);
                    alert('Successfully Swapped')
                } catch (e) {
                    console.error(e);
                    alert(e?.message || e);
                }
            });

            // initial compute
            scheduleSetData();

            // Initially hide swap button and show loading message
            document.getElementById('swapBtn').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('loadingMessage').textContent = 'Please enter amount to start swapping.';
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>